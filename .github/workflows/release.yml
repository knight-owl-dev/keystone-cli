name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.v.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Extract version from tag
        id: v
        shell: bash
        run: |
          echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Validate csproj version matches tag
        shell: bash
        run: |
          CS_VERSION="$(sed -n 's:.*<Version>\(.*\)</Version>.*:\1:p' ./src/Keystone.Cli/Keystone.Cli.csproj | head -n 1)"
          if [[ -z "$CS_VERSION" ]]; then
            echo "ERROR: Could not read <Version> from ./src/Keystone.Cli/Keystone.Cli.csproj" >&2
            exit 1
          fi

          if [[ "$CS_VERSION" != "${{ steps.v.outputs.version }}" ]]; then
            echo "ERROR: csproj <Version> ($CS_VERSION) does not match tag (v${{ steps.v.outputs.version }})" >&2
            exit 1
          fi

      - name: Run unit tests (gate release)
        run: dotnet test ./tests/Keystone.Cli.UnitTests/Keystone.Cli.UnitTests.csproj -c Release

  build-assets:
    name: Build assets (${{ matrix.rid }})
    needs: validate
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-latest
            rid: osx-arm64
          - runner: macos-latest
            rid: osx-x64
          - runner: ubuntu-latest
            rid: linux-x64
          - runner: ubuntu-latest
            rid: linux-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Publish (${{ matrix.rid }})
        run: dotnet publish ./src/Keystone.Cli/Keystone.Cli.csproj -c Release -r ${{ matrix.rid }}

      - name: Package tarball (${{ matrix.rid }})
        shell: bash
        run: bash ./scripts/package-release.sh "${{ needs.validate.outputs.version }}" "${{ matrix.rid }}"

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v6
        with:
          name: dist-${{ matrix.rid }}
          path: artifacts/release/keystone-cli_${{ needs.validate.outputs.version }}_${{ matrix.rid }}.tar.gz
          if-no-files-found: error

  publish-release:
    name: Publish Release
    needs: [validate, build-assets]
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Download all tarballs
        uses: actions/download-artifact@v7
        with:
          path: dist

      - name: Generate checksums.txt
        shell: bash
        run: |
          set -euo pipefail

          echo "Release assets:" 
          (cd dist && find . -maxdepth 3 -type f -name '*.tar.gz' -print | sed 's|^\./||' | sort)

          files=$(cd dist && find . -maxdepth 3 -type f -name '*.tar.gz' -print | sed 's|^\./||')
          if [[ -z "$files" ]]; then
            echo "ERROR: No .tar.gz files found under dist/" >&2
            exit 1
          fi

          # Compute checksums: format is "filename  checksum" (filename first, stripped of artifact directory)
          (cd dist && sha256sum $files) | while read sum file; do
            echo "$(basename "$file")  $sum"
          done | sort > checksums.txt

          echo ""
          echo "checksums.txt:"
          cat checksums.txt

      - name: Prepare checksums body
        shell: bash
        run: |
          set -euo pipefail

          {
            echo ""
            echo "## SHA256 Checksums"
            echo ""
            echo '```'
            cat checksums.txt
            echo '```'
          } > release-body.md

          echo ""
          echo "release-body.md:"
          cat release-body.md

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          name: "keystone-cli v${{ needs.validate.outputs.version }}"
          generate_release_notes: true
          append_body: true
          body_path: release-body.md
          files: |
            dist/**/keystone-cli_${{ needs.validate.outputs.version }}_*.tar.gz
            checksums.txt

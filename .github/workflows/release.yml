name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      version: ${{ steps.v.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: ./.github/actions/setup-dotnet

      - name: Extract version from tag
        id: v
        shell: bash
        run: |
          echo "version=${GITHUB_REF_NAME#v}" >> "${GITHUB_OUTPUT}"

      - name: Validate csproj version matches tag
        shell: bash
        env:
          TAG_VERSION: ${{ steps.v.outputs.version }}
        run: |
          CS_VERSION="$(./scripts/get-version.sh)"
          if [[ "${CS_VERSION}" != "${TAG_VERSION}" ]]; then
            echo "ERROR: csproj <Version> (${CS_VERSION}) does not match tag (v${TAG_VERSION})" >&2
            exit 1
          fi

      - name: Run unit tests (gate release)
        run: dotnet test ./tests/Keystone.Cli.UnitTests/Keystone.Cli.UnitTests.csproj -c Release

  build-assets:
    name: Build assets (${{ matrix.rid }})
    needs: validate
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-latest
            rid: osx-arm64
          - runner: macos-latest
            rid: osx-x64
          - runner: ubuntu-latest
            rid: linux-x64
          - runner: ubuntu-latest
            rid: linux-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: ./.github/actions/setup-dotnet

      - name: Publish (${{ matrix.rid }})
        env:
          RID: ${{ matrix.rid }}
        run: dotnet publish ./src/Keystone.Cli/Keystone.Cli.csproj -c Release -r "${RID}"

      - name: Package tarball (${{ matrix.rid }})
        shell: bash
        env:
          VERSION: ${{ needs.validate.outputs.version }}
          RID: ${{ matrix.rid }}
        run: bash ./scripts/package-release.sh "${VERSION}" "${RID}"

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v6
        with:
          name: dist-${{ matrix.rid }}
          path: artifacts/release/keystone-cli_${{ needs.validate.outputs.version }}_${{ matrix.rid }}.tar.gz
          if-no-files-found: error

      - name: Build .deb package (${{ matrix.rid }})
        if: startsWith(matrix.rid, 'linux-')
        uses: ./.github/actions/build-deb
        with:
          rid: ${{ matrix.rid }}
          version: ${{ needs.validate.outputs.version }}

      - name: Upload .deb artifact
        if: startsWith(matrix.rid, 'linux-')
        uses: actions/upload-artifact@v6
        with:
          name: deb-${{ matrix.rid }}
          path: artifacts/release/keystone-cli_*.deb
          if-no-files-found: error

  test-deb:
    name: Test .deb (${{ matrix.distro }})
    needs: [validate, build-assets]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container: ${{ matrix.image }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: debian-bookworm
            image: debian:bookworm
            arch: amd64
          - distro: ubuntu-24.04
            image: ubuntu:24.04
            arch: amd64

    steps:
      - name: Checkout (for verify script)
        uses: actions/checkout@v6
        with:
          sparse-checkout: scripts
          sparse-checkout-cone-mode: false

      - name: Download .deb artifact
        uses: actions/download-artifact@v7
        with:
          name: deb-linux-x64
          path: deb

      - name: Verify installation
        env:
          VERSION: ${{ needs.validate.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: bash ./scripts/verify-deb-install.sh "./deb/keystone-cli_${VERSION}_${ARCH}.deb"

  publish-release:
    name: Publish Release
    needs: [validate, build-assets, test-deb]
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist

      - name: Generate checksums and release body
        run: bash ./scripts/generate-checksums.sh dist

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          name: "keystone-cli v${{ needs.validate.outputs.version }}"
          generate_release_notes: true
          append_body: true
          body_path: artifacts/release/release-body.md
          files: |
            dist/**/keystone-cli_${{ needs.validate.outputs.version }}_*.tar.gz
            dist/**/keystone-cli_${{ needs.validate.outputs.version }}_*.deb
            artifacts/release/checksums.txt

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: knight-owl-dev
          repositories: |
            apt
            homebrew-tap

      - name: Trigger apt repository update
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: knight-owl-dev/apt
          event-type: release-published
          client-payload: '{"versions": "keystone-cli:${{ needs.validate.outputs.version }}"}'

      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: knight-owl-dev/homebrew-tap
          event-type: release-published
          client-payload: '{"formulas": "keystone-cli:${{ needs.validate.outputs.version }}"}'
